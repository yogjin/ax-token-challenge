---
import Base from '../../layouts/Base.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const days = await getCollection('days');
  return days.map(day => ({
    params: { slug: day.id },
    props: { day },
  }));
}

const { day } = Astro.props;
const { Content, headings } = await render(day);
const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : rawBase + '/';

const tocItems = headings.filter(h => h.depth === 2);
---

<Base title={day.data.title} noStickyHeader>
  <div class="post-layout">
    <article class="post">
      <div class="post-header animate-in">
        <a href={`${base}days/`} class="back-link">&larr; 전체 기록</a>
        <time class="post-date">{day.data.date}</time>
        <h1>{day.data.title}</h1>
        <div class="post-meta">
          {day.data.tools.map(tool => (
            <span class="tag">{tool}</span>
          ))}
          <span class="meta-text">{day.data.problems}개 문제 해결</span>
          <span class="meta-divider">·</span>
          <span class="meta-text">토큰: {day.data.tokens}</span>
        </div>
      </div>
      <div class="post-body animate-in stagger-2">
        <Content />
      </div>
    </article>

    {tocItems.length > 0 && (
      <aside class="toc-aside">
        <nav class="toc">
          <p class="toc-title">ON THIS PAGE</p>
          <ul>
            {tocItems.map(heading => (
              <li>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
  </div>
</Base>

<style>
  .post-layout {
    position: relative;
  }

  .post {
    max-width: 100%;
  }

  /* --- TOC --- */
  .toc-aside {
    display: none;
  }

  @media (min-width: 1100px) {
    .toc-aside {
      display: block;
      position: fixed;
      top: 100px;
      left: calc(50% + 380px);
      width: 200px;
    }

    .toc {
      display: block;
      padding-left: 1rem;
      border-left: 1px solid var(--border);
      font-size: 0.82rem;
      letter-spacing: normal;
    }

    .toc-title {
      font-family: var(--font-body);
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin: 0 0 0.75rem;
    }

    .toc ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc li {
      margin-bottom: 0.5rem;
    }

    .toc a {
      font-size: 0.82rem;
      color: var(--muted);
      text-decoration: none;
      line-height: 1.4;
      display: block;
      transition: color 0.15s;
    }

    .toc a:hover {
      color: var(--fg);
      text-decoration: none;
    }

    .toc a.active {
      color: var(--accent);
      font-weight: 500;
    }
  }

  /* --- Post Header --- */
  .post-header {
    padding-bottom: 2rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--border);
  }

  .back-link {
    font-size: 0.85rem;
    color: var(--muted);
    text-decoration: none;
    font-weight: 500;
    display: inline-block;
    margin-bottom: 1.5rem;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--accent);
    text-decoration: none;
  }

  .post-date {
    display: block;
    font-size: 0.82rem;
    color: var(--muted);
    font-weight: 500;
    font-variant-numeric: tabular-nums;
    margin-bottom: 0.5rem;
  }

  .post-header h1 {
    font-size: 2.2rem;
    margin-bottom: 1rem;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    display: inline-block;
    background: var(--accent-light);
    color: var(--accent);
    font-size: 0.78rem;
    font-weight: 600;
    padding: 0.2rem 0.65rem;
    border-radius: 100px;
    letter-spacing: 0.01em;
  }

  .meta-text {
    font-size: 0.82rem;
    color: var(--muted);
    font-weight: 400;
  }

  .meta-divider {
    color: var(--border);
  }

  .post-body {
    line-height: 1.85;
  }

  .post-body :global(h2) {
    margin-top: 3rem;
  }

  .post-body :global(h3) {
    margin-top: 2rem;
  }

  @media (max-width: 600px) {
    .post-header h1 {
      font-size: 1.7rem;
    }
  }
</style>

<script>
  const tocLinks = document.querySelectorAll('.toc a');
  if (tocLinks.length > 0) {
    const headings = document.querySelectorAll('.post-body h2');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.toc a[href="#${entry.target.id}"]`);
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, { rootMargin: '-80px 0px -70% 0px' });

    headings.forEach(heading => observer.observe(heading));
  }
</script>
